# 初期設定ガイド
- labotの初期設定をまとめています．
- 設定を行わない場合，ボットが正常に動作しないため，初回起動の前に必ず行ってください．
- 初期設定の前に，[起動までの流れ](#%E8%B5%B7%E5%8B%95%E3%81%BE%E3%81%A7%E3%81%AE%E6%B5%81%E3%82%8C)の2まで完了していることを確認してください．
- 所要時間は目安です．

<!-- START doctoc -->
<!-- END doctoc -->

## 【1】設定ファイルのコピー
所要時間 - 1分

`labot/config/` にある3つのファイルのコピーを同じ場所に作ってください．`__init__.py` および `setting.py` のコピーは作成しないでください．
- `_config.yml` - ボット全般の設定
- `_member.yml` - 研究室メンバー設定
- `_gcalendar.gs` - Googleカレンダープラグイン用GAS

コピーした各ファイルを以下のように名前変更してください．正しくファイル名が設定されていない場合，ボットが正常に動作しません．なお，変更前のファイル名は例です．
- `_config_copy.yml` -> `config.yml`
- `_member_copy.yml` -> `member.yml`
- `_gcalendar_copy.gs` -> `gcalendar.gs`

アンダースコアから始まるファイルは設定をリセットする際に使用します．設定をリセットする際は，再度ファイルのコピー＆リネームを行ってください．したがって，これらファイルはクローン時の状態から編集しないでください．

`config.yml` には次のステップでボットのAPIトークンを書き込みます．APIトークンを知っているとボットの操作が可能になるため，管理には十分気をつけてください．特に，不特定多数がアクセス可能な環境には絶対にファイルを置かないようにしてください．

## 【2】ワークスペースへのボット追加
所要時間 - 10分

*一部参考 - https://miyabikno-jobs.com/slackbot-api-token/*

- このステップではワークスペースにボットを追加し，labotがボットを操作するためにAPIトークンを取得するところまで行います．
- ボットを追加したいワークスペースは予め用意しておいてください．
- ワークスペースにアプリを追加できる権限を持つユーザが行ってください．

以降説明のために掲載するスクリーンショットは以下環境によるものです．
```
- OS        macOS Big Sur v11.2.2
- Browser   Google Chrome v89.0.4389.114
- Slack     4.14.0
```

まず，Slackでボットを追加したいワークスペースを開いてください．サイドメニューからAppsを見つけ（見つからない場合，Preferencesで表示させる設定が必要），緑丸のエリアにカーソルを乗せると表示される「+」をクリックして，Apps一覧を右に表示させてください．そして，赤丸で囲ったアイコンをクリックしてください（ブラウザが開きます）．

![01_access_apps](https://user-images.githubusercontent.com/51310314/113472594-51526f80-949f-11eb-882e-d6d3b6a2121c.png)

「slack app directory」というサイトにアクセスされます．赤丸で囲った検索バーに `hubot` と入力してください．すると，候補としてスクリーンショットのように表示されますのでクリックしてください．

![02_search_hubot](https://user-images.githubusercontent.com/51310314/113472605-64653f80-949f-11eb-8227-cb41fce9cf63.png)

Hubotのページにアクセスしたところで，右上にボットを稼働したいワークスペースが表示されているか確認してください．もし異なる場合は変更してください．問題なければ，赤丸で囲った「Add to Slack」をクリックしてください．

![03_select_hubot](https://user-images.githubusercontent.com/51310314/113472607-662f0300-949f-11eb-9be3-78346b857c21.png)

ワークスペースへの追加直前にUsername（ボット名）を設定する必要があります（青丸）．ボットの名前を好きなように設定してください．ここで設定したボット名は，ボットからメッセージが送信される際に表示されるものになります．なお，ボット名はいつでも変更できます．

入力が完了したところで，赤丸の「Add Hubot Integration」をクリックしてください．

![04_add_hubot](https://user-images.githubusercontent.com/51310314/113472608-66c79980-949f-11eb-9571-1c675616b51a.png)

ブラウザは閉じず，一旦Slackに戻ってボットを稼働したいワークスペースを開いてください．サイドメニューのAppsに先に指定した名前のHubotが追加されているか確認してください．もし見つからない場合，他のワークスペースに追加されている可能性があります．

![05_check_added](https://user-images.githubusercontent.com/51310314/113472609-67603000-949f-11eb-8873-6dd2c97a8557.png)

ブラウザに戻ると，先ほどのページから以下のようなページに遷移しているはずです．赤丸で囲った部分にボットのAPIトークンが表示されているはずです．

「Setup Instructions」の `HUBOT_SLACK_TOKEN=`のあとに表示されているトークンと，「Integration Settings」の「API Token」に表示されているトークンは同じです．このどちらかをコピーしてください（`HUBOT_SLACK_TOKEN=` は不要です）．

![06_check_token](https://user-images.githubusercontent.com/51310314/113472611-68915d00-949f-11eb-8660-2f3a43a31005.png)

トークンは `x` から始まる文字列のはずです．コピーしたトークンを `config/config.yml` の1行目の `token: ` の後にペーストしてください．この際 `x***-********-********-****************` はダミーなので消してください．

※各行の `:` の後には必ず半角スペースを空けてください．
```yml
token: x***-********-********-****************
...
```

次にボットのアイコンの設定をします．同じページを少し下にスクロールすると「Customize Icon」という項目があるので好きなアイコンや絵文字を設定してください．

![07_customize_icon](https://user-images.githubusercontent.com/51310314/113472612-69c28a00-949f-11eb-83c2-67c1c7bcc760.png)


最後に `config.yml` のボット名とアイコンの設定を行います．先にブラウザ上で設定したボット名とアイコンと同じものを，2,3行目の `name` と `icon` にそれぞれ設定してください．なお，アイコンは画像ファイルへの直リンクを貼ってください（GoogleドライブやDropboxなど活用してください）．
```yml
token: x***-********-********-****************
name: bot
icon: https://****.**/***/***.png
...
```

ここまでの設定が完了したところで，[起動までの流れ](#%E8%B5%B7%E5%8B%95%E3%81%BE%E3%81%A7%E3%81%AE%E6%B5%81%E3%82%8C)の4を行ってボットを起動してみてください．そして，ボットをチャンネルに追加するか，Appsのボットを選択して（ボット宛のダイレクトメッセージ）， `!version` というメッセージを送信してみてください．メンションは不要です．

ボットの稼働に成功していれば，versionコマンドに反応して，間もなくボットからlabotのバージョンのメッセージが送られてくるはずです！


## 【3】設定ファイルの編集
所要時間 - 5分~ (研究室メンバー数による)

設定はyml形式のファイルで管理されてます．ymlはフォーマットが少しでも異なると正常に読み込まれません．ファイルを編集する際は以下のことを守ってください．他にもルールはありますが，ここでは特に注意すべき点を挙げます．

- 各項目のコロン(`:`)の後には半角スペースを空ける．
- 項目ごとに改行する．
- インデントにはタブを使わず，半角スペースを使う（半角スペース2文字を推奨します）．


### 3.1. ボット全般の設定
基本的には設定変更の必要はないため，スキップしても構いません．

ボット全般の設定は `config/config.yml` で行います． `config.yml` は以下のような内容になっています．

```yml
token: x***-********-********-****************
name: bot
icon: https://****.**/***/***.png
order:
  text: DEFAULT
group:
  text: DEFAULT
gcalendar:
  gas: https://script.google.com/macros/s/******/exec
  channel: calendar
  time: mon9
  colors: [f8e352, d5848b, 7b9ad0, 51a1a2, ae8dbc, c08e47, e5ab47]
  msg: お疲れ様です！今週も頑張っていきましょう！

```

各項目の詳細は以下の通りです．

- token, name, icon - ステップ2で既に設定済みです
- order - "プラグイン:順番シャッフル"の設定
    - text - 順番シャッフルの結果が投稿される際の冒頭メッセージ．
    - デフォルトでは以下のようになってます．  
        <img width="285" alt="01_shuffle" src="https://user-images.githubusercontent.com/51310314/113475279-8ebef900-94af-11eb-8c68-fb051f903a8a.png">

- group - "プラグイン:グループ分け"の設定
    - text - グループ分けの結果が投稿される際の冒頭メッセージ．
    - デフォルトでは以下のようになってます．  
        <img width="347" alt="02_group" src="https://user-images.githubusercontent.com/51310314/113475280-8ff02600-94af-11eb-8d51-a5189f3387b5.png">
- gcalendar
    - ステップ4で設定するため，現段階では編集不要です．


### 3.2. 研究室メンバーの設定
この設定は必ずボットの運用を開始する前に行ってください．

研究室メンバーの設定は `config/member.yml` で行います． `member.yml` は以下の構成が繰り返し続くような内容になっています．1メンバーにつき以下ブロックを用意するようにしてください．

```yml
FamilyName:
  name: LastName
  class: [teacher, student, B3, B4, M1, M2]

```

各項目の詳細は以下の通りです．
- FamilyName - メンバーの姓（キャピタライズ必須）（コロンの後ではなく前を書き換える）
    - name - メンバーの名前（キャピタライズ必須）
    - class - メンバーの所属するクラス
        - 仕様上，学生には必ず `student` クラスを設定してください．
        - 順番シャッフルやグループ分けの際に，指定クラスに所属するメンバーに限定した操作ができます．

例えば，研究室のメンバーが以下であるとします．
```
- 先生 - 癒月ちょこ
- 生徒 - 紫咲シオン，湊あくあ，百鬼あやめ，大空スバル
```

このときの `member.yml` は次のようになります．
```yml
Yuzuki:
    name: Choco
    class: teacher
Murasaki:
    name: Shion
    class: student, manzi
Minato:
    name: Aqua
    class: student, manzi
Nakiri:
    name: Ayame
    class: student, manzi
Ozora:
    name: Subaru
    class: student

```

メンバー情報の変更に限ってはコマンドでもできます．詳しくは `README.md` の `研究室メンバー設定` の[コマンド](#%E3%82%B3%E3%83%9E%E3%83%B3%E3%83%89-1)を確認してください．


## 【4】Googleカレンダープラグインの設定
所要時間 - 15分

### Googleカレンダープラグインを利用しない方
ボットの初期設定はこれで終了です．お疲れ様でした！

`config.yml` の `gcalendar/gas` が以下のようなデフォルトのダミーURLの場合，自動的にプラグインが無効化されます．もし変更していてプラグインを使わない場合はボットが正常に動作しなくなるため，以下の内容をコピーしてデフォルトに戻しておいてください．

```yml
...
gcalendar:
  gas: https://script.google.com/macros/s/******/exec
...
```


### Googleカレンダープラグインを利用する方
予め，Googleアカウントとイベントを取得したいカレンダーを準備しておいてください．

準備ができたところで，[Googleカレンダー](https://calendar.google.com/)にアクセスしてください．
右上（緑丸）でイベントを取得したいカレンダーにアクセスできるアカウントが選択されていることと，
左下（青丸）でそのカレンダーが表示されていることの2点を確認してください．
その上で，右上のアカウント表示の左にある設定アイコン（赤丸）をクリックしてください．

![01_open_calendar](https://user-images.githubusercontent.com/51310314/113472627-7e9f1d80-949f-11eb-978c-0dae27acfc18.png)

設定ページではサイドメニューからイベントを取得したいカレンダーを選択してください（青丸）．他のアカウントが作成したカレンダーの場合は，「他のカレンダーの設定」に表示されています．

そして，下の方にスクロールすると「カレンダーの統合」という項目があります．そのすぐ下にカレンダーIDがあります（赤丸）．この文字列を `..dar.google.com` まですべてコピーしてください．

![02_check_id](https://user-images.githubusercontent.com/51310314/113472628-819a0e00-949f-11eb-8dce-b880c3ecbae4.png)

次にステップ1でコピー＆リネームした `config/gcalendar.gs` を開いてください．
3行目の `(ここにIDをペースト)` を消して，先ほどコピーしたカレンダーIDをペーストしてください（前後のダブルクォーテーションは残す）．なお，カレンダーIDはカレンダーにアクセスできるキーであるため，外部に漏れないようSlackのAPIトークンと同様の管理を行ってください．

```javascript
// カレンダーID（外部に漏れないよう注意！）
// "_gcalendar.gs"を同じ場所にコピーして"gcalendar.gs"にリネームしてから3行目を追記してください
var calId = "(ここにIDをペースト)"

function doGet(e) {
  start_date_year = e.parameter.year;
...
```

次にGoogle Apps Script (GAS)の[ダッシュボード](https://script.google.com/home)を開いてください．
これまでGASを利用したことがない場合は，以下スクリーンショットのような表示になっているはずです．

まず，右上のアカウントが先ほどカレンダーIDを取得する際に使用したアカウントと同じか確認してください（スクリーンショットの場合は異なってますが無視してください）．Googleカレンダーにアクセスできないアカウントから作成したスクリプトは正常に動作しません．

アカウントに問題なければ，「APPS SCRIPT を作成」（赤丸）をクリックしてください．

![03_access_gas](https://user-images.githubusercontent.com/51310314/113472629-82cb3b00-949f-11eb-8888-453f07177307.png)

コードエディターが開かれます．ファイル `コード.gs` が選択されている状態で，右のエディターの中身をすべて消し， `calId` をセット済みの `gcalendar.gs` を丸ごとコピペしてください．
プロジェクト名（`無題のプロジェクト`）やファイル名（`コード.gs`）を変更する必要はありませんが，わかりやすい名前に変えても問題ありません．

![04_open_editor](https://user-images.githubusercontent.com/51310314/113472630-8363d180-949f-11eb-97e6-ebcca194cc83.png)

右上に表示されている「デプロイ」の青いボタンをクリックし，表示されるメニューから一番上の「新しいデプロイ」をクリックしてください．

![05_open_deploy](https://user-images.githubusercontent.com/51310314/113472632-83fc6800-949f-11eb-99d1-5101680a94cc.png)


デプロイ関連のモーダルウィンドウが表示されたところで，サイドメニューの「種類の選択」の横の設定アイコンをクリックし，表示されるメニューから「ウェブアプリ」をクリックしてください．

![06_select_type](https://user-images.githubusercontent.com/51310314/113472634-8494fe80-949f-11eb-9b25-5181b6ec7039.png)

右にフォームが表示されます．3つの項目を入力＆選択してください（青丸）．

- 新しい説明文 - 好きなように設定していただいて結構です
- 次のユーザーとして実行 - 「自分（メアド）」を選択してください
- アクセスできるユーザ - 「全員」を選択してください

入力＆選択が完了したところで，右下の「デプロイ」のボタンをクリックしてください（赤丸）．ボタンをクリックしてから少し時間がかかることがあります．

![07_edit_deploy](https://user-images.githubusercontent.com/51310314/113472635-8494fe80-949f-11eb-9abd-0e29abcf3e9f.png)

デプロイの更新が終わると，以下のように「ウェブアプリのURL」が表示されますので，コピーボタンをクリックする等してURLをコピーしてください．なお，このURLもAPIトークンやカレンダーIDと同様に外部に漏らさないように注意してくだだい．コピーが完了したところで，右下の「完了」のボタンをクリックし，開いていたページは閉じて問題ありません．

![08_copy_url](https://user-images.githubusercontent.com/51310314/113472637-852d9500-949f-11eb-970e-b2e27256d438.png)

今度は `config.yml` を開いてください．下の方に `gcalendar` という項目があります．この中でも `gas` のダミーURLを消し，先ほどコピーしたURLを貼り付けてください．

```yml
...
gcalendar:
  gas: https://script.google.com/macros/s/******/exec
  channel: calendar
...
```

最後にイベント投稿の設定を行います．`channel`,`time`,`colors`,`text`の4つの項目があります．

```yml
...
gcalendar:
  gas: https://script.google.com/macros/s/******/exec
  channel: calendar
  time: mon9
  colors: [f8e352, d5848b, 7b9ad0, 51a1a2, ae8dbc, c08e47, e5ab47]
  text: お疲れ様です！今週も頑張っていきましょう！
```

- `channel` - ウィークイベント投稿チャンネル名
- `time` - ウィークイベント投稿曜日＆時間（ex. `mon9`）
- `colors` - 投稿メッセージに使用する曜日カラー．16進数カラーコードで指定する（シャープ不要）．デフォルトカラーは以下の通り．

    <!-- - ref.) https://qiita.com/suin/items/1f3898c1fa108b1e47b1 -->
    ![](https://via.placeholder.com/16/f8e352/FFFFFF/?text=%20) `月` 
    ![](https://via.placeholder.com/16/d5848b/FFFFFF/?text=%20) `火` 
    ![](https://via.placeholder.com/16/7b9ad0/FFFFFF/?text=%20) `水` 
    ![](https://via.placeholder.com/16/51a1a2/FFFFFF/?text=%20) `木` 
    ![](https://via.placeholder.com/16/ae8dbc/FFFFFF/?text=%20) `金` 
    ![](https://via.placeholder.com/16/c08e47/FFFFFF/?text=%20) `土` 
    ![](https://via.placeholder.com/16/e5ab47/FFFFFF/?text=%20) `日`     
- `text` - ウィークイベント投稿時の冒頭テキスト

`colors`と`text`はデフォルト設定のままでも問題ありません．

`channel` はGoogleカレンダーから取得した1週間分のイベント（ウィークイベント）を自動投稿するチャンネル名です．ボットを稼働するワークスペースに存在しないチャンネル名を指定すると正常に動作しないため，必ず確認してください．

`time`は毎週自動投稿する曜日＆時間です．デフォルトでは月曜9時に投稿されます． `@channel` 付きのメッセージが投稿されるため，深夜・早朝や休日の設定は避けることをオススメします．

Googleカレンダープラグインの設定は以上です．お疲れ様でした！
あとはボットを起動して放置（常時稼働）するだけです．起動方法は `README.md` の [🚀 起動までの流れ](#-%E8%B5%B7%E5%8B%95%E3%81%BE%E3%81%A7%E3%81%AE%E6%B5%81%E3%82%8C)の4を確認してください．

---

初期設定ガイドについて，誤字脱字・質問等ございましたら，遠慮なく[Twitter@nyu923](https://twitter.com/nyu923)にリプライ，もしくはイシューを立てて頂ければと思います．
